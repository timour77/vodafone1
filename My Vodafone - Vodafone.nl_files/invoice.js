VF.namespace("VF.pages.my.invoice"),VF.pages.my.invoice=function(){"use strict";function r(){1===VF.core.globals.features["consumer.invoices.core"]&&1===VF.core.globals.features["consumer.invoices.details"]&&(x=$.localStorage.getItem("current_billing_customer"),null!==x&&(e(),i(),l(),VF.util.nextBestActivity().init("next-best-activity")))}function e(){$("body").on("click",".heading-row",function(r){$(this).closest(".bill-detail-table").toggleClass("mobile-visible-content"),r.preventDefault()}).on("click",".js-pdf-download-tag",function(){VF.core.tag().trackButtonClick("my:rekeningen:rekening:download rekening PDF")}).on("click",".js-subcat-event",function(r){r.preventDefault();var e=$(this).attr("href");e+="&subscriber="+j,window.location.href=e}).on("click",".js-wizard-show-toggle",function(r){r.preventDefault(),VF.core.tag().trackButtonClick("my:rekeningen:rekening:uitleg"),VF.Wizard.show()})}function t(r,e){j="undefined"!=typeof e&&e,y.set("subscriberId",j),$(".bill-content").addClass("preloader"),VF.Wizard.reset(),y.getInvoice(w).done(c).fail(p)}function o(r,e,t){"undefined"!=typeof t.billingArrangements&&t.billingArrangements.length>1&&$(".content").addClass("multiple-ba")}function n(r,e,t){var o,n=document.location,i=[n.origin,n.pathname].join(""),l=!1;y.getInvoice(w).then(function(r){return o=r,y.set("billingArrangementId",e),y.getAllBills()}).then(function(r){for(var n=r.length-1;n>=0;n--)"object"==typeof r[n].cycle&&parseInt(r[n].billing_arrangment_id)===e&&r[n].cycle.month===o.cycle.month&&r[n].cycle.year===o.cycle.year&&(i+="?invoice="+r[n].number,l=!0);l?(VF.Wizard.reset(),window.location.href=i):(VF.core.popupManager().createPopup(!0,!0,{title:"Geen rekening gevonden...",text:"<p>Wij hebben voor de maand "+VF.util.date().toMonth(o.cycle.month)+" "+o.cycle.year+" geen rekening gevonden voor "+$('.ba-dropdown-links [data-value="'+e+'"]').text()+".</p>",confirm:{text:"OK",onClick:VF.core.popupManager().closePopup}}),d.setCurrent(t),y.set("billingArrangementId",t))})}function i(){A=VF.core.globals.account.billing_customers[x].billing_customer_id,b=VF.core.globals.account.billing_customers[x].is_consumer,VF.Wizard.set("isConsumer",b),q=b?"amount_including_vat":"amount_excluding_vat",k=VF.util.url().getUrlVars(),w="undefined"!=typeof k?k.invoice:0,j="undefined"!=typeof k&&"undefined"!=typeof k.subscriber&&k.subscriber,y.set("billingCustomerId",A).set("subscriberId",j)}function l(){$(".content").addClass("preloader"),y.getInvoice(w).done(function(r){var e=getDeepProp(r,"charges.subscriber_charges_summaries");"undefined"!=typeof e&&1===e.length?(j=e[0].subscriber_id,y.set("subscriberId",j),y.getInvoice(w).done(a).fail(p)):a(r)}).fail(p)}function p(r){$(".js-page-error").fadeIn(),$(".content").removeClass("preloader")}function s(r){var e=$.Deferred(),t={},o="undefined"!=typeof r.subscriber_charges?r.subscriber_charges:r.charges;o.non_disclosed_amount=r.non_disclosed_amount;var n=getDeepProp(r,"charges.subscriber_charges_summaries");if("undefined"!=typeof n){1===n.length&&(o=r.charges,"undefined"!=typeof r.subscriber_charges&&(o.recurring_charges=r.subscriber_charges.recurring_charges,o.subscriber_usage_charges=r.subscriber_charges.subscriber_usage_charges,o.invoice_usage_charges=void 0),o.non_disclosed_amount=n[0].total_undisclosed_charge_amount);for(var i=0,l=n.length;i<l;i++)n[i].subscriber_id===j.toString()&&(o.non_disclosed_amount=n[i].total_undisclosed_charge_amount)}return t.invoice=r,t.subscriberId=j,t.isConsumer=b,t.billingCustomerId=A,t.usageData=f(r,o),t.payment=VF.pages.my.invoiceGeneral.getPaymentInfo(r,b),y.getCurrentBillingArrangement().done(function(r){t.billingArrangement=r,e.resolve(t)}),e.promise()}function a(r){s(r).always(function(e){VF.template.compile(r.type.id,e,function(e){if($(".content").html(e).removeClass("preloader"),VF.core.formOfAddress().setFormOfAddress(),VF.Wizard.set("url","/my/rekeningen/wizard.json"),r.is_first_bill){var t=$.localStorage.getItem("wizardFirstBillShown");VF.Wizard.setVars("is_first_bill",!0),VF.Wizard.on("ready",function(){setTimeout(function(){t||VF.Wizard.show(),$.localStorage.setItem("wizardFirstBillShown",1)},2e3)})}VF.Wizard.on("hide",function(){"undefined"!=typeof r&&r.is_first_bill?window.usabilla_live("trigger","uitleg rekening wizard POST_firstbill"):window.usabilla_live("trigger","uitleg rekening wizard POST")}),VF.Wizard.setVars({specification_url:"/my/rekeningen/rekening-specificatie.shtml?invoice="+w+"&startAtPoint=specification_content&fromBillWizard=1",analysis_url:"/my/rekeningen/rekening-analyse.shtml?invoice="+w+"&startAtPoint=analysis_content&fromBillWizard=1"}),VF.Wizard.set("externalUrl","/rest/my/invoice/wizard/"+A+"?billing_arrangement_id="+r.billing_arrangment_id+"&invoice_id="+r.number+"&invoice_close_date="+r.close_date);var o=k.startAtPoint;null!=o&&(VF.Wizard.set({skipIntro:!0,startAtPoint:o}),VF.Wizard.on("ready",function(){setTimeout(VF.Wizard.show,500)})),VF.Wizard.on("ready",function(){$(".js-link-wizard").toggleClass("hide","BILL"!==r.type.id)}),VF.Wizard.init()}),VF.pages.my.invoiceGeneral.renderInvoiceDropdown(r,y),"true"===$.localStorage.getItem("bc_is_consumer")&&$(".js-link-btwspec").removeClass("hide"),$(".mu-dropdown-btn").text($(".current a .mu-name").text())})}function c(r){s(r).always(function(e){VF.template.compile(r.type.id+"-invoice-table",e,function(r){$(".bill-content").html(r).removeClass("preloader")})})}function f(r,e){if("undefined"==typeof e)return[];for(var t=[],o=[{id:"recurring_charges",data:e.recurring_charges,template:"recurring-charges"},{id:"invoice_usage_charges",data:v(e.invoice_usage_charges),template:"usage-charges"},{id:"subscriber_usage_charges",data:e.subscriber_usage_charges,template:"subscriber-usage-charges"},{id:"one_time_charges",data:e.one_time_charges},{id:"hardware_charges_total",data:e.hardware_charges_total},{id:"discount_charges",data:e.discount_charges},{id:"credit_charges",data:e.credit_charges},{id:"non_disclosed_amount",data:e.non_disclosed_amount}],n=0;n<o.length;n++)if("undefined"!=typeof e[o[n].id]){var i,l,p,s=o[n];"undefined"!=typeof s.template?(p=r,p.chargeData=s.data,p.isConsumer=b,VF.template.compile(s.template,p,function(r){l=r})):(i=h(s.id,r,e),l=void 0),("undefined"!=typeof i&&i.length>0||"undefined"!=typeof l)&&t.push({id:s.id,columns:i,data:s.data,html:l})}return t}function h(r,e,t){var o=[];switch(r){case"one_time_charges":if("undefined"==typeof t.one_time_charges)return;o.push({label:"<h2>Eenmalige kosten</h2>",value:"{{description}}",width:40}),o.push({label:"Aantal",value:"{{formatQuantity quantity}}",width:40}),o.push({label:u(t.one_time_charges_total,!0),value:b?"{{moneyString amount.amount_including_vat}}":"{{moneyString amount.amount_excluding_vat}}",width:20});break;case"non_disclosed_amount":if("undefined"==typeof t.non_disclosed_amount)return;o.push({label:"<h2>Derde partij kosten</h2>",value:"",width:80}),o.push({label:u(t.non_disclosed_amount,!1),value:"",width:20});break;case"hardware_charges_total":if("undefined"==typeof t.hardware_charges_total)return;o.push({label:"<h2>Hardware</h2>",value:"",width:80}),o.push({label:u(t.hardware_charges_total,!1),value:"",width:20});break;case"discount_charges":if("undefined"==typeof t.discount_charges_total)return;o.push({label:"<h2>Korting</h2>",value:"{{description}}",width:80}),o.push({label:u(t.discount_charges_total,!0),value:b?"{{negativeMoneyString amount.amount_including_vat}}":"{{negativeMoneyString amount.amount_excluding_vat}}",width:20});break;case"credit_charges":if("undefined"==typeof t.credit_charges_total)return;o.push({label:"<h2>Crediteringen</h2>",value:"{{description}}",width:80}),o.push({label:u(t.credit_charges_total,!0),value:b?"{{negativeMoneyString amount.amount_including_vat}}":"{{negativeMoneyString amount.amount_excluding_vat}}",width:20})}return o}function u(r,e){var t,o='<button class="js-toggle-content content-toggle"><span class="icon icon-chevron-down"></span></button>';return b||!e?t=VF.util.prices().toMoneyString(r.amount_including_vat)+o:(t=VF.util.prices().toMoneyString(r.amount_excluding_vat)+o,t+='<br/><span class="vat-amount">'+VF.util.prices().toMoneyString(r.amount_including_vat)+" incl. btw</span>"),t}function v(r){var e={};return"undefined"==typeof r?e:($.each(r,function(r,t){"undefined"==typeof e[t.event_type]&&(e[t.event_type]={type:t.event_type,data:[]}),e[t.event_type].data.push(t)}),e)}var y=new VF.services.billing.InvoicesService;y.set("billingArrangementId",$.localStorage.getItem("current_billing_arrangement"));var d=new VF.pages.my.invoiceGeneral.BillingArrangementSelector;d.setService(y),d.on("change",n),d.on("render",o);var g=new VF.pages.my.invoiceGeneral.MultiUserSelector;g.setService(y),g.on("change",t);var m="rekening-wizard";VF.Wizard.on("show",function(){VF.core.tagMy().trackFormStep({formName:m,stepName:"start"})}),VF.Wizard.on("hide",function(){VF.core.tagMy().trackFormStep({formName:m,stepName:"einde"})}),VF.Wizard.on("point",function(r,e){VF.core.tagMy().trackFormStep({formName:m,step:e.idx,stepName:e.title})});var x,A,b,j,k,q,w;return{init:r}}(),VF.core.globals.callbacks.my_account.push(VF.pages.my.invoice.init),$(document).ready(function(){VF.core.features().processFeature("consumer.invoices.core")});